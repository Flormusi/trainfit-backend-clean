generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          String              @id @default(cuid())
  email                       String              @unique
  password                    String
  role                        Role                @default(CLIENT)
  name                        String?
  createdAt                   DateTime            @default(now())
  updatedAt                   DateTime            @updatedAt
  status                      String?             @default("active")
  resetPasswordExpire         DateTime?
  resetPasswordToken          String?
  hasCompletedOnboarding      Boolean             @default(false)
  appointmentsAsClient        Appointment[]       @relation("ClientAppointments")
  appointmentsAsTrainer       Appointment[]       @relation("TrainerAppointments")
  clientNotes                 ClientNote[]        @relation("ClientNotesRel")
  trainerNotes                ClientNote[]        @relation("TrainerNotesRel")
  clientProfile               ClientProfile?
  exercises                   Exercise[]
  invoices                    Invoice[]
  receivedMessages            Message[]           @relation("ReceivedMessages")
  sentMessages                Message[]           @relation("SentMessages")
  notifications               Notification[]
  assignedNutritionPlans      NutritionPlan[]     @relation("ClientNutritionPlans")
  createdNutritionPlans       NutritionPlan[]     @relation("TrainerNutritionPlans")
  progressRecords             Progress[]
  reminders                   Reminder[]
  assignedRoutines            Routine[]           @relation("ClientRoutines")
  createdRoutines             Routine[]           @relation("TrainerRoutines")
  routineAssignmentsAsClient  RoutineAssignment[] @relation("ClientAssignments")
  routineAssignmentsAsTrainer RoutineAssignment[] @relation("TrainerAssignments")
  subscription                Subscription?
  trainersAsClient            TrainerClient[]     @relation("ClientRelation")
  clientsAsTrainer            TrainerClient[]     @relation("TrainerRelation")
  trainerProfile              TrainerProfile?
  createdTemplates            RoutineTemplate[]   @relation("CreatedTemplates")
  trainerPayments             PaymentPreference[] @relation("TrainerPayments")
  clientPayments              PaymentPreference[] @relation("ClientPayments")
  calendarIntegrations        CalendarIntegration[] @relation("ClientCalendarIntegrations")
}

model ClientProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique
  name                String
  phone               String?
  goals               String[]
  weight              Float?
  medicalConditions   String?
  medications         String?
  injuries            String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  initialObjective    String   @default("Sin definir")
  trainingDaysPerWeek Int      @default(3)
  height              Float?
  age                 Int?
  fitnessLevel        String?
  gender              String?
  nickname            String?
  profileImage        String?
  lastTrainingDate    DateTime?
  user                User     @relation(fields: [userId], references: [id])
}

model Routine {
  id            String              @id @default(cuid())
  name          String
  description   String?
  duration      String?
  notes         String?
  trainerId     String
  clientId      String
  exercises     Json?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  notifications Notification[]
  progress      Progress[]
  client        User                @relation("ClientRoutines", fields: [clientId], references: [id])
  trainer       User                @relation("TrainerRoutines", fields: [trainerId], references: [id])
  assignments   RoutineAssignment[]
}

model Progress {
  id        String   @id @default(cuid())
  routineId String
  date      DateTime @default(now())
  notes     String?
  metrics   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  routine   Routine  @relation(fields: [routineId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model ClientNote {
  id        String   @id @default(cuid())
  content   String
  clientId  String
  trainerId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  client    User     @relation("ClientNotesRel", fields: [clientId], references: [id])
  trainer   User     @relation("TrainerNotesRel", fields: [trainerId], references: [id])
}

model TrainerProfile {
  id        String  @id @default(cuid())
  userId    String  @unique
  name      String
  specialty String?
  defaultPercentIncrement Float? @default(7.5)
  user      User    @relation(fields: [userId], references: [id])
}

model Exercise {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String?
  equipment   String?
  difficulty  String?
  muscles     String[]
  objectives  String[] // Objetivos de entrenamiento: fuerza, hipertrofia, resistencia, etc.
  trainerId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  imageUrl    String?
  videoUrl    String?
  trainer     User     @relation(fields: [trainerId], references: [id])
}

model NutritionPlan {
  id          String   @id @default(cuid())
  name        String
  description String?
  meals       Json?
  trainerId   String
  clientId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  client      User     @relation("ClientNutritionPlans", fields: [clientId], references: [id])
  trainer     User     @relation("TrainerNutritionPlans", fields: [trainerId], references: [id])
}

model TrainerClient {
  id        String   @id @default(cuid())
  trainerId String
  clientId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  client    User     @relation("ClientRelation", fields: [clientId], references: [id], onDelete: Cascade)
  trainer   User     @relation("TrainerRelation", fields: [trainerId], references: [id], onDelete: Cascade)

  @@unique([trainerId, clientId])
}

model Notification {
  id        String   @id @default(cuid())
  title     String
  message   String
  type      String
  userId    String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  routineId String?
  routine   Routine? @relation(fields: [routineId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RoutineAssignment {
  id                      String   @id @default(cuid())
  clientId                String
  routineId               String
  trainerId               String
  startDate               DateTime
  endDate                 DateTime
  assignedDate            DateTime @default(now())
  trainingObjectives      Json?    // Array de objetivos: ["strength", "hypertrophy", "endurance"]
  pyramidalRepsPattern    String?  // Patrón piramidal seleccionado: "ascending", "descending", "diamond", "custom"
  pyramidalRepsSequence   Json?    // Secuencia personalizada: [8, 10, 12, 10, 8]
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  client                  User     @relation("ClientAssignments", fields: [clientId], references: [id], onDelete: Cascade)
  routine                 Routine  @relation(fields: [routineId], references: [id], onDelete: Cascade)
  trainer                 User     @relation("TrainerAssignments", fields: [trainerId], references: [id], onDelete: Cascade)
}

model Message {
  id          String   @id @default(cuid())
  content     String
  senderId    String
  receiverId  String
  isRead      Boolean  @default(false)
  messageType String   @default("text")
  attachments Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId, receiverId])
  @@index([createdAt])
}

model Appointment {
  id          String            @id @default(cuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  status      AppointmentStatus @default(SCHEDULED)
  location    String?
  notes       String?
  clientId    String
  trainerId   String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  client      User              @relation("ClientAppointments", fields: [clientId], references: [id], onDelete: Cascade)
  trainer     User              @relation("TrainerAppointments", fields: [trainerId], references: [id], onDelete: Cascade)
  reminders   Reminder[]

  @@index([startTime])
  @@index([clientId])
  @@index([trainerId])
}

model Reminder {
  id            String       @id @default(cuid())
  title         String
  message       String
  reminderTime  DateTime
  isActive      Boolean      @default(true)
  isSent        Boolean      @default(false)
  reminderType  ReminderType
  userId        String
  appointmentId String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([reminderTime])
  @@index([userId])
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  plan                 SubscriptionPlan   @default(BASIC)
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  trialEnd             DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  payments             Payment[]
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Payment {
  id              String        @id @default(cuid())
  subscriptionId  String
  stripePaymentId String?       @unique
  amount          Float
  currency        String        @default("usd")
  status          PaymentStatus @default(PENDING)
  description     String?
  paymentMethod   String?
  failureReason   String?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
}

model Invoice {
  id              String        @id @default(cuid())
  userId          String
  stripeInvoiceId String?       @unique
  amount          Float
  currency        String        @default("usd")
  status          InvoiceStatus @default(DRAFT)
  description     String?
  dueDate         DateTime?
  paidAt          DateTime?
  invoiceNumber   String?       @unique
  downloadUrl     String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model RoutineTemplate {
  id                    String   @id @default(cuid())
  name                  String
  description           String?
  trainingObjective     String   // "fuerza", "hipertrofia", "resistencia", "definicion", "funcional"
  level                 String   // "principiante", "intermedio", "avanzado"
  daysPerWeek           Int      // Número de días por semana
  gender                String?  // "masculino", "femenino", "unisex"
  duration              String?  // Duración estimada de la sesión
  exercises             Json     // Array de ejercicios con estructura similar a Routine
  notes                 String?
  isActive              Boolean  @default(true)
  createdBy             String   // ID del entrenador que creó la plantilla
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  creator               User     @relation("CreatedTemplates", fields: [createdBy], references: [id])

  @@index([trainingObjective])
  @@index([level])
  @@index([daysPerWeek])
  @@index([isActive])
}

enum Role {
  ADMIN
  TRAINER
  CLIENT
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum ReminderType {
  APPOINTMENT
  WORKOUT
  NUTRITION
  PROGRESS_CHECK
  CUSTOM
}

enum SubscriptionPlan {
  BASIC
  PREMIUM
  PROFESSIONAL
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

model CalendarIntegration {
  id           String   @id @default(cuid())
  clientId     String
  provider     String   // 'google', 'outlook', 'icloud'
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  scope        String?
  email        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  client       User     @relation("ClientCalendarIntegrations", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, provider])
  @@index([clientId])
  @@index([isActive])
}

model PaymentPreference {
  id                String   @id @default(cuid())
  preferenceId      String?  @unique
  trainerId         String
  clientId          String
  amount            Float
  description       String
  planType          String
  status            String   @default("pending")
  externalReference String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  trainer           User     @relation("TrainerPayments", fields: [trainerId], references: [id])
  client            User     @relation("ClientPayments", fields: [clientId], references: [id])
}
